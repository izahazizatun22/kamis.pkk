<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title><%= product.name %> - Spice Dums</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="icon" href="/images/logo.png" type="image/png" />
</head>
<body>
  <header class="site-header">
    <div class="logo">SPICE DUMS</div>
    <nav>
      <a href="/">Home</a>
      <a href="/">Menu</a>
      <a href="/about">About</a>
    </nav>
    <div class="auth">
      <% if (!user) { %>
        <a href="/login">Login</a> | <a href="/register">Register</a>
        <button type="button" id="cartButton" class="cart-button">üõí<span id="cartCount" class="cart-count"><%= cartCount %></span></button>
      <% } else { %>
        <span style="margin-right: 16px;">Hi <%= user.username %></span>
        <button type="button" id="cartButton" class="cart-button">üõí<span id="cartCount" class="cart-count"><%= cartCount %></span></button>
        <form method="post" action="/logout" style="display:inline"><button type="submit" class="btn" style="padding: 6px 12px; margin-top: 0;">Logout</button></form>
      <% } %>
    </div>
  </header>
  <main class="container">
    <section class="product-detail">
      <img src="<%= product.imageResolved || '/images/placeholder.png' %>" alt="<%= product.name %>" />
      <div class="details">
        <h1><%= product.name %></h1>
        <p><%= product.description %></p>
        <div class="price">Rp <%= Number(product.price).toLocaleString('id-ID') %></div>
        <form method="post" action="/cart/add" id="productAddForm" data-price="<%= Number(product.price) %>" onsubmit="return submitProductAdd(event)">
          <input type="hidden" name="product_id" value="<%= product.id %>" />
          <label style="margin-top:16px">Tambah ke Keranjang</label>
          <input name="qty" type="number" min="1" value="1" />
          <div id="productSubtotal" style="margin-top:8px; font-weight:800;">Subtotal: Rp <%= Number(product.price).toLocaleString('id-ID') %></div>
          <button class="btn" style="margin-top:12px">Add to Cart</button>
        </form>
      </div>
    </section>

    <section class="reviews" id="reviews">
      <h2>Reviews & Ratings</h2>
      
      <% if (reviews && reviews.length > 0) { %>
        <div style="display: grid; gap: 16px; margin-bottom: 40px;">
          <% reviews.forEach(r => { %>
            <div class="review-item">
              <div class="review-header">
                <div>
                  <div class="review-author"><%= r.username %></div>
                  <div class="review-rating">‚≠ê <%= r.rating %>/5</div>
                </div>
              </div>
              <div class="review-comment"><%= r.comment %></div>
            </div>
          <% }) %>
        </div>
      <% } else { %>
        <p style="color: #808080; margin-bottom: 32px;">Belum ada review untuk produk ini. Jadilah yang pertama!</p>
      <% } %>

      <% if (user) { %>
        <div style="background: #f5f5f5; padding: 32px; border-radius: 12px;">
          <h3 style="margin-top: 0;">Tulis Review</h3>
          <form method="post" action="/product/<%= product.id %>/review">
            <label>Rating</label>
            <select name="rating">
              <% for(let i=5;i>=1;i--){ %>
                <option value="<%= i %>" <%= i === 5 ? 'selected' : '' %>>
                  <%= '‚≠ê'.repeat(i) %> <%= i %>/5
                </option>
              <% } %>
            </select>
            <label style="margin-top: 16px;">Komentar</label>
            <textarea name="comment" placeholder="Tulis review Anda di sini..." style="min-height: 100px;"></textarea>
            <button class="btn">Kirim Review</button>
          </form>
        </div>
      <% } else { %>
        <div style="background: #f5f5f5; padding: 24px; border-radius: 12px; text-align: center;">
          <p style="margin: 0;"><a href="/login" style="color: #FF7F5C; font-weight: 600; text-decoration: none;">Login</a> untuk memberi review.</p>
        </div>
      <% } %>
    </section>
  </main>
  <div class="cart-modal-backdrop" id="cartBackdrop">
    <div class="cart-modal" id="cartModal">
      <div class="cart-modal-header">
        <h3 style="margin:0">Keranjang</h3>
        <button class="cart-close" id="cartClose">‚úï</button>
      </div>
      <div class="cart-modal-content">
        <div id="cartList"></div>
        <div style="display:flex; justify-content:flex-end; margin-top:12px;">
          <div style="display:flex; flex-direction:column; align-items:flex-end; gap:8px;">
            <div id="cartTotal" style="font-weight:800; text-align:right;">Subtotal: Rp 0</div>
            <form method="post" action="/cart/checkout" id="cartCheckoutForm" target="_blank"><button class="btn" type="submit" style="max-width:200px;">Checkout</button></form>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    const backdrop = document.getElementById('cartBackdrop');
    const cartClose = document.getElementById('cartClose');
    const cartList = document.getElementById('cartList');
    const cartTotal = document.getElementById('cartTotal');
    function openCart(){ backdrop.classList.add('cart-visible'); }
    function closeCart(){ backdrop.classList.remove('cart-visible'); }
    if (cartClose) cartClose.addEventListener('click', closeCart);
    if (backdrop) backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) closeCart(); });
    async function refreshCart(){
      const res = await fetch('/cart/json');
      const data = await res.json();
      cartList.innerHTML = data.items.map(it => `
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; border-bottom:1px solid #e8e8e8; padding:8px 0;">
          <div style="display:flex; align-items:center; gap:12px;">
            <img src="${it.image || '/images/placeholder.png'}" style="width:48px; height:48px; object-fit:cover; border-radius:8px;" />
            <div>
              <div style="font-weight:700;">${it.name}</div>
              <div style="color:#808080;">Rp ${Number(it.price).toLocaleString('id-ID')}</div>
            </div>
          </div>
          <div style="display:flex; align-items:center; gap:12px;">
            <form method="post" action="/cart/update" onsubmit="return submitAjax(event)">
              <input type="hidden" name="product_id" value="${it.product_id}" />
              <input name="qty" type="number" min="0" value="${it.qty}" style="width:70px;" onchange="this.form.dispatchEvent(new Event('submit', {cancelable:true}))" />
            </form>
            <form method="post" action="/cart/remove" onsubmit="return submitAjax(event)">
              <input type="hidden" name="product_id" value="${it.product_id}" />
              <button class="btn btn-sm" type="submit" style="background:#d9534f; border-color:#d9534f; width:auto;">Remove</button>
            </form>
          </div>
        </div>
      `).join('');
      cartTotal.textContent = 'Subtotal: Rp ' + Number(data.total).toLocaleString('id-ID');
      const c = document.getElementById('cartCount');
      if (c) c.textContent = data.cartCount;
    }
    function submitAjax(e){
      e.preventDefault();
      const form = e.target;
      const url = form.getAttribute('action');
      const body = new URLSearchParams(new FormData(form));
      fetch(url, { method:'POST', headers:{ 'Accept':'application/json' }, body }).then(r=>r.json()).then(()=>{ refreshCart(); });
      return false;
    }
    const cartBtn = document.getElementById('cartButton');
    if (cartBtn) {
      cartBtn.addEventListener('click', async (e) => { e.preventDefault(); await refreshCart(); openCart(); });
    }
    const addForm = document.getElementById('productAddForm');
    function updateSubtotal(){
      if(!addForm) return;
      const qtyInput = addForm.querySelector('input[name="qty"]');
      const subtotalEl = document.getElementById('productSubtotal');
      const qty = Math.max(1, parseInt(qtyInput && qtyInput.value ? qtyInput.value : '1', 10));
      const unitPrice = Number(addForm.getAttribute('data-price') || 0);
      if (subtotalEl) subtotalEl.textContent = 'Subtotal: Rp ' + Number(unitPrice * qty).toLocaleString('id-ID');
    }
    function submitProductAdd(e){
      e.preventDefault();
      const form = e.target;
      const body = new URLSearchParams(new FormData(form));
      fetch('/cart/add', { method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded', 'Accept':'application/json' }, body })
        .then(r=>r.json())
        .then(()=>{ refreshCart(); openCart(); });
      return false;
    }
    if (addForm) {
      const qtyInput = addForm.querySelector('input[name="qty"]');
      if (qtyInput) qtyInput.addEventListener('input', updateSubtotal);
      updateSubtotal();
    }
    const checkoutForm = document.getElementById('cartCheckoutForm');
    if (checkoutForm) {
      checkoutForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const res = await fetch('/cart/json');
        const data = await res.json();
        await fetch('/cart/checkout', { method: 'POST', headers: { 'Accept': 'application/json' } });
        const lines = (data.items || []).map(it => `- ${it.name} x${it.qty} @ Rp ${Number(it.price).toLocaleString('id-ID')}`).join('\n');
        const message = `Halo Spice Dums.\nOrder:\n${lines}\nSubtotal: Rp ${Number(data.total).toLocaleString('id-ID')}\nMohon konfirmasi.`;
        const wa = 'https://wa.me/6285775211374?text=' + encodeURIComponent(message);
        window.open(wa, '_blank');
        const firstId = (data.items && data.items[0] && data.items[0].product_id) ? data.items[0].product_id : null;
        closeCart();
        if (firstId) { window.location.href = '/product/' + firstId + '#reviews'; } else { window.location.href = '/#menu'; }
      });
    }
  </script>
</body>
</html>
